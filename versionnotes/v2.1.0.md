# v2.1.0 - Multi-Backend Architecture and CLI Refactor

This version introduces a significant architectural shift to support multiple authentication backends (Google Workspace and Infomaniak KSuite) simultaneously or independently.

## Breaking Changes

### 1. Initialization and Authentication CLI
The `gas-fakes init` and `gas-fakes auth` commands have been refactored to be backend-agnostic.
- **`init` Refactor**: Now features a multi-select prompt to choose between Google and KSuite. Manual scope entry for ADC has been replaced by automatic discovery from `appsscript.json`.
- **`auth` Refactor**: Iterates through all platforms defined in your `.env` file. You can target a specific backend using `gas-fakes auth --backend ksuite`.
- **New Environment Variable**: `GF_PLATFORM_AUTH` is now used in `.env` to define the authorized platforms (comma-separated).

### 2. Multi-Platform Identity Management
The core `Auth` singleton now manages a map of identities rather than a single global user. 
- `Session.getActiveUser()` and `Session.getEffectiveUser()` now return identities matching the current `ScriptApp.__platform`.
- `ScriptApp.getOAuthToken()` dynamically returns the token for the active backend.

### 3. Lazy Store Initialization
`PropertiesService` and `CacheService` models (specifically those using Upstash) are now resolved lazily. This prevents premature authentication triggers when importing `gas-fakes`.

## New Features

- **Infomaniak KSuite Support**: Full integration for KSuite tokens. `DriveApp` can now switch to KSuite via `ScriptApp.__platform = 'ksuite'`.
- **Automated Scope Discovery**: `gas-fakes` now automatically reads your `appsscript.json` manifest to configure scopes for both DWD and ADC methods. 
    - **Note on ADC Sensitive Scopes**: If using ADC with sensitive/restricted scopes, ensure you provide an OAuth2 client credentials JSON file during `init` to avoid Google blocking the login process.
- **Enhanced Auth Reporting**: A single, concise summary report is now printed during startup, identifying exactly which backends are active and which authentication method (ADC/DWD/TOKEN) is being used.
- **Quiet Mode by Default**: Significantly reduced log noise during the startup phase.

## Technical Improvements

- **Recursive Loading Protection**: Improved Proxy logic in `ScriptApp` to prevent stack overflows during complex service cross-dependencies.
- **Main Thread Authorization Detection**: Fixed `Auth.hasAuth()` to correctly detect main-thread identity status, eliminating redundant worker initialization calls.
- **Dotenv Silence**: Suppressed the repetitive `dotenv` injection "tips" in the console output.

## <img src="../logo.png" alt="gas-fakes logo" width="50" align="top"> Further Reading

- [getting started](GETTING_STARTED.md) - how to handle authentication for restricted scopes.
- [readme](README.md)
- [gas fakes cli](gas-fakes-cli.md)
- [ksuite poc](ksuite_poc.md)
- [apps script - a lingua franca for workspace platforms](https://ramblings.mcpher.com/apps-script-a-lingua-franca/)
- [running gas-fakes on google cloud run](https://github.com/brucemcpherson/gas-fakes-containers)
- [running gas-fakes on google kubernetes engine](https://github.com/brucemcpherson/gas-fakes-containers)
- [running gas-fakes on Amazon AWS lambda](https://github.com/brucemcpherson/gas-fakes-containers)
- [Yes – you can run native apps script code on AWS Lambda!](https://ramblings.mcpher.com/apps-script-on-aws-lambda/)
- [initial idea and thoughts](https://ramblings.mcpher.com/a-proof-of-concept-implementation-of-apps-script-environment-on-node/)
- [Inside the volatile world of a Google Document](https://ramblings.mcpher.com/inside-the-volatile-world-of-a-google-document/)
- [Apps Script Services on Node – using apps script libraries](https://ramblings.mcpher.com/apps-script-services-on-node-using-apps-script-libraries/)
- [Apps Script environment on Node – more services](https://ramblings.mcpher.com/apps-script-environment-on-node-more-services/)
- [Turning async into synch on Node using workers](https://ramblings.mcpher.com/turning-async-into-synch-on-node-using-workers/)
- [All about Apps Script Enums and how to fake them](https://ramblings.mcpher.com/all-about-apps-script-enums-and-how-to-fake-them/)
- [colaborators](collaborators.md) - additional information for collaborators
- [oddities](oddities.md) - a collection of oddities uncovered during this project
- [named colors](named-colors.md)
- [sandbox](sandbox.md)
- [senstive scopes](senstive_scopes.md)
- [using apps script libraries with gas-fakes](libraries.md)
- [how libhandler works](libhandler.md)
- [article:using apps script libraries with gas-fakes](https://ramblings.mcpher.com/how-to-use-apps-script-libraries-directly-from-node/)
- [named range identity](named-range-identity.md)
- [adc and restricted scopes](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [push test pull](pull-test-push.md)
- [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)
- [gas-fakes-cli now has built in mcp server and gemini extension](https://ramblings.mcpher.com/gas-fakes-cli-now-has-built-in-mcp-server-and-gemini-extension/)
- [gas-fakes CLI: Run apps script code directly from your terminal](https://ramblings.mcpher.com/gas-fakes-cli-run-apps-script-code-directly-from-your-terminal/)
- [How to allow access to sensitive scopes with Application Default Credentials](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [Supercharge Your Google Apps Script Caching with GasFlexCache](https://ramblings.mcpher.com/supercharge-your-google-apps-script-caching-with-gasflexcache/)
- [Fake-Sandbox for Google Apps Script: Granular controls.](https://ramblings.mcpher.com/fake-sandbox-for-google-apps-script-granular-controls/)
- [A Fake-Sandbox for Google Apps Script: Securely Executing Code Generated by Gemini CLI](https://ramblings.mcpher.com/gas-fakes-sandbox/)
- [Power of Google Apps Script: Building MCP Server Tools for Gemini CLI and Google Antigravity in Google Workspace Automation](https://medium.com/google-cloud/power-of-google-apps-script-building-mcp-server-tools-for-gemini-cli-and-google-antigravity-in-71e754e4b740)
- [A New Era for Google Apps Script: Unlocking the Future of Google Workspace Automation with Natural Language](https://medium.com/google-cloud/a-new-era-for-google-apps-script-unlocking-the-future-of-google-workspace-automation-with-natural-a9cecf87b4c6)
- [Next-Generation Google Apps Script Development: Leveraging Antigravity and Gemini 3.0](https://medium.com/google-cloud/next-generation-google-apps-script-development-leveraging-antigravity-and-gemini-3-0-c4d5affbc1a8)
- [Modern Google Apps Script Workflow Building on the Cloud](https://medium.com/google-cloud/modern-google-apps-script-workflow-building-on-the-cloud-2255dbd32ac3)
- [Bridging the Gap: Seamless Integration for Local Google Apps Script Development](https://medium.com/@tanaike/bridging-the-gap-seamless-integration-for-local-google-apps-script-development-9b9b973aeb02)
- [Next-Level Google Apps Script Development](https://medium.com/google-cloud/next-level-google-apps-script-development-654be5153912)
- [Secure and Streamlined Google Apps Script Development with gas-fakes CLI and Gemini CLI Extension](https://medium.com/google-cloud/secure-and-streamlined-google-apps-script-development-with-gas-fakes-cli-and-gemini-cli-extension-67bbce80e2c8)
- [Secure and Conversational Google Workspace Automation: Integrating Gemini CLI with a gas-fakes MCP Server](https://medium.com/google-cloud/secure-and-conversational-google-workspace-automation-integrating-gemini-cli-with-a-gas-fakes-mcp-0a5341559865)
- [A Fake-Sandbox for Google Apps Script: A Feasibility Study on Securely Executing Code Generated by Gemini CL](https://medium.com/google-cloud/a-fake-sandbox-for-google-apps-script-a-feasibility-study-on-securely-executing-code-generated-by-cc985ce5dae3)
